# E-commerce API

Multi-tenant SaaS E-commerce REST API built with **Node.js, TypeScript, PostgreSQL, and Redis**.

**Generated by**: SDLC Agent Swarm (Phase 3 Validation)  
**Date**: 2026-01-31

---

## ğŸ¯ Project Overview

Production-ready multi-tenant e-commerce API with complete tenant isolation, enterprise authentication, and comprehensive observability.

**Key Features**:
- âœ… Multi-tenant SaaS with database-level isolation (PostgreSQL RLS)
- âœ… OAuth2 JWT authentication with MFA for admins
- âœ… RBAC (Admin, Merchant, Customer roles)
- âœ… Product catalog, inventory management, orders, payments
- âœ… Stripe payment integration
- âœ… Structured logging (JSON with PII masking)
- âœ… Prometheus metrics (RED method)
- âœ… Health endpoints + 99.9% uptime SLO
- âœ… 7-year audit retention (INV-029)

---

## ğŸ“ Project Structure

```
ecommerce-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                   # Main server entry point
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ logger.ts              # Structured logging (Pino)
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts     # JWT authentication (IN V-001)
â”‚   â”‚   â”œâ”€â”€ tenant.middleware.ts   # Tenant isolation (INV-005/006)
â”‚   â”‚   â””â”€â”€ metrics.middleware.ts  # Prometheus metrics (INV-034/035)
â”‚   â”œâ”€â”€ routes/                    # Express route handlers
â”‚   â”œâ”€â”€ services/                  # Business logic layer
â”‚   â”œâ”€â”€ repositories/              # Data access layer (Prisma)
â”‚   â””â”€â”€ types/                     # TypeScript type definitions
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma              # Database schema (multi-tenant)
â”œâ”€â”€ docker-compose.yml             # PostgreSQL + Redis
â”œâ”€â”€ package.json                   # Dependencies
â”œâ”€â”€ tsconfig.json                  # TypeScript config (strict mode)
â””â”€â”€ .env.example                   # Environment variables template

Documentation:
â”œâ”€â”€ PRD.md                         # Product Requirements Document
â”œâ”€â”€ ARCHITECTURE.md                # Solution Architecture (C4 diagrams, ADRs)
â””â”€â”€ DOMAIN_MODEL.md                # Event Storming, ERD, bounded contexts
```

---

## ğŸš€ Quick Start

### Prerequisites
- Node.js 20+ LTS
- PostgreSQL 16+
- Redis 7+
- Docker & Docker Compose

### 1. Clone and Install

```bash
cd ecommerce-api
npm install
```

### 2. Start Infrastructure

```bash
# Start PostgreSQL and Redis
docker-compose up -d

# Verify containers are running
docker ps
```

### 3. Configure Environment

```bash
# Copy example env file
cp .env.example .env

# Generate RSA key pair for JWT
openssl genrsa -out private.key 2048
openssl rsa -in private.key -pubout -out public.key

# Update .env with keys
JWT_PRIVATE_KEY=$(cat private.key)
JWT_PUBLIC_KEY=$(cat public.key)
```

### 4. Run Database Migrations

```bash
# Generate Prisma client
npm run prisma:generate

# Run migrations
npm run prisma:migrate

# (Optional) Open Prisma Studio to view database
npm run prisma:studio
```

### 5. Start Development Server

```bash
# Watch mode (auto-reload)
npm run dev

# Server starts on http://localhost:3000
```

---

## ğŸ“Š API Endpoints

### Health & Metrics

```
GET /health            # Liveness check (always 200 if server running)
GET /ready             # Readiness check (validates DB + Redis connectivity)
GET /metrics           # Prometheus metrics
```

### Tenant Management

```
POST /api/v1/tenants   # Register new tenant (returns tenant_id, API key, subdomain)
```

### Authentication

```
POST /api/v1/auth/login          # Login (returns JWT, valid for 1 hour)
POST /api/v1/auth/mfa/setup      # Setup MFA (admin only, returns QR code)
POST /api/v1/auth/mfa/verify     # Verify MFA code
```

### Products (Protected, requires JWT)

```
GET    /api/v1/products          # List products (paginated, filterable)
POST   /api/v1/products          # Create product (merchant/admin)
GET    /api/v1/products/:id      # Get product details
PATCH  /api/v1/products/:id      # Update product (merchant/admin)
DELETE /api/v1/products/:id      # Soft delete product (admin)
```

### Orders (Protected, requires JWT)

```
POST   /api/v1/orders            # Create order (customer)
GET    /api/v1/orders            # List orders (filtered by role)
GET    /api/v1/orders/:id        # Get order details
PATCH  /api/v1/orders/:id/status # Update order status (merchant/admin)
DELETE /api/v1/orders/:id        # Cancel order
```

### Payments (Protected, requires JWT)

```
POST /api/v1/payments/intents    # Create Stripe PaymentIntent
POST /api/v1/webhooks/stripe     # Stripe webhook handler
```

---

## ğŸ§ª Testing

```bash
# Run all tests
npm test

# Watch mode
npm run test:watch

# Coverage report
npm run test:coverage
```

**Test Coverage Targets**:
- Business logic: 90%
- API endpoints: Integration tests for all routes
- E2E: Critical user journeys (place order, payment, cancellation)

---

## ğŸ”’ Security & Compliance

### Authentication (INV-001)
- OAuth2 with JWT (RS256 signing)
- Token expiry: 1 hour
- Public key exposed at `/.well-known/jwks.json`

### Authorization (INV-002, INV-003)
- RBAC with 3 roles: ADMIN, MERCHANT, CUSTOMER
- Middleware enforces permissions at route level
- Least privilege principle

### Multi-Factor Authentication (INV-004)
- TOTP (Time-Based One-Time Password)
- Required for admin accounts
- Google Authenticator compatible

### Multi-Tenancy (INV-005, INV-006)
- Database-level isolation (PostgreSQL RLS policies)
- tenant_id in ALL tables
- Middleware sets `app.current_tenant_id` per request

### Secrets Management (INV-014 to INV-019)
- Environment variables (`.env` for local)
- Never log secrets (see `logger.ts` redaction)
- 90-day rotation for service accounts (manual in MVP)

### Audit Logging (INV-029, INV-030)
- ALL mutations logged (create, update, delete)
- 7-year retention
- Fields: timestamp, user_id, tenant_id, action, resource_id, changes (before/after)

---

## ğŸ“ˆ Observability

### Structured Logging (INV-033)
```json
{
  "level": "info",
  "timestamp": "2026-01-31T12:00:00.000Z",
  "correlationId": "req-uuid-123",
  "tenantId": "tenant-uuid-456",
  "userId": "user-uuid-789",
  "method": "POST",
  "path": "/api/v1/orders",
  "statusCode": 201,
  "duration": 145,
  "message": "Order created successfully"
}
```

**PII Masking**: email, password, mfaSecret automatically redacted

### Prometheus Metrics (INV-034, INV-035)
- **RED Method**: Request Rate, Error Rate, Duration
- **Business Metrics**: orders_total (by tenant, status)
- **Latency Buckets**: 10ms to 5s

### SLO Monitoring (INV-037)
- **Availability**: 99.9% uptime (43 minutes downtime/month)
- **Latency**: p95 < 200ms (read), p95 < 500ms (write)
- **Error Budget**: 86 minutes/quarter

---

## ğŸ—ï¸ Architecture

### Technology Stack
- **Runtime**: Node.js 20 LTS
- **Language**: TypeScript 5.3 (strict mode)
- **Framework**: Express.js 4.x
- **Database**: PostgreSQL 16 (with RLS for multi-tenancy)
- **Cache**: Redis 7
- **ORM**: Prisma 5.x
- **Auth**: jsonwebtoken, bcrypt, speakeasy (TOTP)
- **Payments**: Stripe SDK
- **Observability**: Pino (logging), prom-client (metrics)

### System Architecture (C4 Level 2)
```
[Customer/Developer]
        â”‚
        â”‚ HTTPS (TLS 1.3)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   REST API Server     â”‚
â”‚   (Node.js/TypeScript)â”‚
â”‚   - JWT auth          â”‚
â”‚   - RBAC middleware   â”‚
â”‚   - Structured logs   â”‚
â”‚   - Prometheus metricsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚           â”‚
        â”‚ SQL       â”‚ Redis protocol
        â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚
   â”‚  (RLS)   â”‚  â”‚ (Cache)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ HTTPS
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Stripe  â”‚
   â”‚  API    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Multi-Tenancy Strategy
1. **Database Schema**: ALL tables include `tenant_id`
2. **RLS Policies**: PostgreSQL enforces isolation
3. **Application Layer**: Middleware extracts tenant_id from JWT
4. **Cache Keys**: Scoped by tenant_id

---

## ğŸ“ Development

### Code Style
```bash
# Lint
npm run lint

# Format
npm run format
```

**Standards**:
- TypeScript strict mode âœ…
- ESLint + Prettier âœ…
- No `any` types âœ…
- All functions typed âœ…

### Database Migrations
```bash
# Create migration
npx prisma migrate dev --name add_feature_x

# Apply migrations to production
npx prisma migrate deploy
```

---

## ğŸš¢ Deployment

### Docker Build
```bash
# Build image
docker build -t ecommerce-api:1.0.0 .

# Run container
docker run -p 3000:3000 -e DATABASE_URL=... ecommerce-api:1.0.0
```

### Production Checklist
- [ ] Set `NODE_ENV=production`
- [ ] Use managed PostgreSQL (AWS RDS, Azure Database)
- [ ] Use managed Redis (AWS ElastiCache, Azure Cache)
- [ ] Enable SSL/TLS for database connections
- [ ] Rotate JWT keys (RS256 key pair)
- [ ] Set up Prometheus + Grafana for monitoring
- [ ] Configure alerts (SLO violations, error rate >5%)
- [ ] Enable audit log archival (7-year retention per INV-029)

---

## ğŸ“– Documentation

- **[PRD.md](PRD.md)**: Product Requirements Document
- **[ARCHITECTURE.md](ARCHITECTURE.md)**: Solution Architecture (C4 diagrams, ADRs)
- **[DOMAIN_MODEL.md](DOMAIN_MODEL.md)**: Event Storming, ERD, bounded contexts

---

## ğŸ¯ Success Metrics

### Technical Metrics
- **API Latency**: p95 < 200ms (read), p95 < 500ms (write)
- **Uptime**: 99.9% SLO (measured monthly)
- **Error Rate**: < 1% (non-4xx errors)
- **Test Coverage**: 90% for business logic

### Compliance
- **Multi-Tenancy**: 100% tenant isolation (validated via tests)
- **Audit Logging**: 100% mutation coverage
- **Invariants Satisfied**: 15/35 invariants (INV-001 to INV-006, INV-014, INV-029, INV-030, INV-033 to INV-037)

---

## ğŸ¤ Contributing

Generated by SDLC Agent Swarm. Contributions welcome!

---

## ğŸ“„ License

MIT License - see LICENSE file for details

---

**Project Status**: âœ… BETA - Ready for real-world validation  
**Generated**: 2026-01-31 via Phase 3 SDLC Agent Swarm execution
