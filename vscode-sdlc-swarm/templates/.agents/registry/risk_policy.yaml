# Risk Management Policy
# Defines risk assessment, approval gates, and escalation for SDLC swarm operations

metadata:
  version: "1.0"
  last_updated: "2026-01-30"
  owner: "Driver Agent"
  enforcement: "collapse_policy.md (critical risk gate)"

# Risk Categories: How we classify risks
risk_categories:
  critical:
    description: "Production outage, data loss, security breach, compliance violation"
    severity_range: [90, 100]
    approval_required:
      - verifier
      - security_architect
      - cto_or_delegate
    auto_block: true
    sla_review: "Immediate (within 1 hour)"
    escalation_path:
      - level_1: "Security team + SRE on-call"
      - level_2: "Engineering VP + CISO"
      - level_3: "CTO + CEO (SEV-1 incident)"
    examples:
      - "Exposing PII without encryption (INV-009 violation)"
      - "Deploying without rollback plan (INV-021 violation)"
      - "No authentication on multi-tenant endpoint (INV-001, INV-005 violation)"
      - "Secrets committed to git (INV-015 violation)"
      - "DAST finds critical SQL injection (INV-028 violation)"

  high:
    description: "Performance degradation, partial availability loss, security vulnerability"
    severity_range: [70, 89]
    approval_required:
      - verifier
      - domain_expert
      - tech_lead
    auto_block: false  # Can proceed with mitigation plan
    sla_review: "4 hours"
    escalation_path:
      - level_1: "Tech lead + domain expert"
      - level_2: "Engineering manager + architect"
      - level_3: "Engineering VP"
    examples:
      - "Test coverage drops below 80% (INV-024 violation)"
      - "Multi-region failover not tested (INV-019)"
      - "SLO breach risk >1% (INV-036)"
      - "Dependency with known HIGH CVE (INV-027)"
      - "No health endpoint (INV-034 violation)"

  medium:
    description: "Technical debt, maintainability concerns, developer experience degradation"
    severity_range: [40, 69]
    approval_required:
      - verifier
      - code_owner
    auto_block: false
    sla_review: "2 business days"
    escalation_path:
      - level_1: "Code owner + reviewer"
      - level_2: "Tech lead"
    examples:
      - "Breaking backward compatibility without migration plan (INV-023)"
      - "Skipping PR gate (INV-025 violation)"
      - "No runbook for new service (INV-031)"
      - "Postmortem delayed >5 days (INV-032)"
      - "Copyleft license dependency (INV-037)"

  low:
    description: "Code style, documentation gaps, minor technical debt"
    severity_range: [0, 39]
    approval_required:
      - verifier
    auto_block: false
    sla_review: "1 week"
    escalation_path:
      - level_1: "Code owner"
    examples:
      - "Missing docstrings (non-blocking)"
      - "Linter warnings (non-blocking)"
      - "Test flakiness <5%"
      - "Minor refactoring opportunity"
      - "Documentation outdated (non-critical)"

# Severity Scoring Formula
# Risk severity = (Probability × Impact × Exposure) - (Detection × Mitigation)
# Scale: 0-100 (higher = more severe)
scoring:
  formula: "(P × I × E) - (D × M)"
  components:
    probability:
      description: "Likelihood of risk materializing"
      scale:
        certain: 1.0      # Will definitely happen
        likely: 0.7       # >50% chance
        possible: 0.4     # 10-50% chance
        unlikely: 0.2     # <10% chance
        rare: 0.05        # Near impossible
    
    impact:
      description: "Damage if risk materializes"
      scale:
        catastrophic: 100  # Data loss, security breach, compliance violation
        major: 70          # Partial outage, SLO breach
        moderate: 40       # Performance degradation, technical debt
        minor: 10          # Style issues, documentation gaps
        negligible: 1      # No user impact
    
    exposure:
      description: "Scope of affected systems/users"
      scale:
        global: 1.0        # All tenants, all regions
        regional: 0.7      # Single region or subset of tenants
        isolated: 0.4      # Single service or component
        local: 0.1         # Single function or file
    
    detection:
      description: "How quickly we detect if risk materializes"
      scale:
        immediate: 0.5     # Real-time alerts, automated tests
        fast: 0.3          # Within 1 hour
        delayed: 0.1       # >1 day to detect
        none: 0.0          # No monitoring
    
    mitigation:
      description: "Effectiveness of existing safeguards"
      scale:
        strong: 0.5        # Multiple layers (tests, gates, monitoring, rollback)
        moderate: 0.3      # Some safeguards (tests or gates)
        weak: 0.1          # Manual review only
        none: 0.0          # No mitigation

  # Example calculations:
  examples:
    - scenario: "Deploying without rollback plan"
      calculation:
        probability: 0.4    # Possible (if process skipped)
        impact: 100         # Catastrophic (could cause outage)
        exposure: 1.0       # Global (all users)
        detection: 0.3      # Fast (monitoring exists)
        mitigation: 0.0     # None (no rollback = no mitigation)
      severity: "(0.4 × 100 × 1.0) - (0.3 × 0) = 40 - 0 = 40 (MEDIUM)"
      note: "Would be CRITICAL if deployed (impact realized), but MEDIUM risk beforehand"

    - scenario: "Secrets in git"
      calculation:
        probability: 1.0    # Certain (already happened)
        impact: 100         # Catastrophic (security breach)
        exposure: 1.0       # Global (all environments)
        detection: 0.3      # Fast (secret scanning)
        mitigation: 0.0     # None (already exposed)
      severity: "(1.0 × 100 × 1.0) - (0.3 × 0) = 100 - 0 = 100 (CRITICAL)"

    - scenario: "Test coverage 75% (target 80%)"
      calculation:
        probability: 0.4    # Possible (gaps could cause bugs)
        impact: 40          # Moderate (technical debt)
        exposure: 0.4       # Isolated (specific features)
        detection: 0.5      # Immediate (coverage reports)
        mitigation: 0.3     # Moderate (manual testing exists)
      severity: "(0.4 × 40 × 0.4) - (0.5 × 0.3) = 6.4 - 0.15 = 6.25 (LOW)"

# Approval Requirements
approval_gates:
  critical_risks:
    required_approvers:
      - role: "verifier"
        mandatory: true
        veto_power: true
      - role: "security_architect"
        mandatory: true
        veto_power: true
      - role: "cto_or_delegate"
        mandatory: true
        veto_power: true
    approval_mode: "unanimous"  # All must approve
    timeout: "24 hours"
    fallback: "Block (no deploy allowed)"
  
  high_risks:
    required_approvers:
      - role: "verifier"
        mandatory: true
        veto_power: true
      - role: "domain_expert"
        mandatory: true
        veto_power: false  # Can be overridden by tech_lead
      - role: "tech_lead"
        mandatory: true
        veto_power: true
    approval_mode: "majority"  # 2 of 3 must approve
    timeout: "4 hours"
    fallback: "Escalate to critical"
  
  medium_risks:
    required_approvers:
      - role: "verifier"
        mandatory: true
        veto_power: true
      - role: "code_owner"
        mandatory: true
        veto_power: false
    approval_mode: "all"
    timeout: "2 business days"
    fallback: "Proceed with documented risk"
  
  low_risks:
    required_approvers:
      - role: "verifier"
        mandatory: true
        veto_power: false
    approval_mode: "single"
    timeout: "1 week"
    fallback: "Auto-approve"

# Escalation Policy
escalation:
  triggers:
    - "No approval within SLA timeout"
    - "Verifier veto invoked"
    - "Invariant violation detected (any of 35)"
    - "Risk severity increases during implementation"
    - "Multiple related risks detected (>3 MEDIUM = 1 HIGH)"
  
  paths:
    critical_risk:
      - step: 1
        notify: ["security_team", "sre_oncall"]
        action: "Immediate incident response, block all deploys"
        sla: "15 minutes"
      - step: 2
        notify: ["engineering_vp", "ciso"]
        action: "Executive review, determine rollback strategy"
        sla: "1 hour"
      - step: 3
        notify: ["cto", "ceo"]
        action: "SEV-1 incident declared, company-wide communication"
        sla: "4 hours"
    
    high_risk:
      - step: 1
        notify: ["tech_lead", "domain_expert"]
        action: "Technical review, mitigation plan required"
        sla: "1 hour"
      - step: 2
        notify: ["engineering_manager", "architect"]
        action: "Management decision, may downgrade if mitigated"
        sla: "4 hours"
      - step: 3
        notify: ["engineering_vp"]
        action: "VP approval or escalate to critical"
        sla: "1 business day"
    
    medium_risk:
      - step: 1
        notify: ["code_owner", "reviewer"]
        action: "Peer review, risk acknowledgment"
        sla: "4 hours"
      - step: 2
        notify: ["tech_lead"]
        action: "Tech lead approval or downgrade to low"
        sla: "2 business days"
    
    low_risk:
      - step: 1
        notify: ["code_owner"]
        action: "Document in PR, no blocking"
        sla: "1 week"

# Risk Tracking
tracking:
  location: ".agents/memory/risk_ledger.md"
  entry_format: |
    ### RISK-YYYY-NNN: [Risk Title]
    - Category: [critical|high|medium|low]
    - Severity Score: [0-100]
    - Probability: [certain|likely|possible|unlikely|rare]
    - Impact: [catastrophic|major|moderate|minor|negligible]
    - Exposure: [global|regional|isolated|local]
    - Detection: [immediate|fast|delayed|none]
    - Mitigation: [strong|moderate|weak|none]
    - Approval Status: [PENDING|APPROVED|BLOCKED]
    - Approvers: [List of roles/names]
    - Residual Risk: [What remains after mitigation]
    - Invariants Impacted: [INV-XXX, INV-YYY]
    - Position Card ID: [CARD-YYYY-NNN]
  
  retention: "7 years (INV-029 compliance)"
  review_frequency: "Weekly for CRITICAL/HIGH, Monthly for MEDIUM/LOW"

# Integration with Collapse Policy
collapse_integration:
  critical_risk_gate:
    rule: "If ANY risk has severity ≥90 (CRITICAL), collapse is BLOCKED"
    formula_impact: "S(card) < 0 due to w_r=8.0 × R=90 = -720 penalty"
    override: "Requires CTO approval + mitigation plan"
  
  high_risk_gate:
    rule: "If ANY risk has severity ≥70 (HIGH) without mitigation, reflexion triggered"
    formula_impact: "S(card) reduced by 8.0 × 70 = -560 penalty"
    override: "Requires mitigation plan + tech lead approval"
  
  medium_risk_threshold:
    rule: "Multiple MEDIUM risks (≥3) treated as 1 HIGH risk"
    formula_impact: "Cumulative penalty = 8.0 × (40 + 50 + 60) = -1200"
    override: "Requires risk consolidation + mitigation plan"
  
  verifier_veto:
    rule: "Verifier can veto ANY risk (regardless of severity)"
    formula_impact: "S(card) = -∞ (immediate collapse rejection)"
    override: "No override (Verifier is final authority)"

# Mitigation Requirements
mitigation:
  required_elements:
    - "Root cause analysis (why risk exists)"
    - "Mitigation actions (specific steps to reduce severity)"
    - "Residual risk assessment (what remains after mitigation)"
    - "Monitoring plan (how to detect if risk materializes)"
    - "Rollback procedure (how to undo change if needed)"
    - "Evidence of mitigation effectiveness (tests, validation)"
  
  acceptance_criteria:
    critical: "Severity must reduce to ≤69 (HIGH or lower) OR executive approval"
    high: "Severity must reduce to ≤39 (MEDIUM or lower) OR mitigation plan documented"
    medium: "Mitigation plan documented, no severity reduction required"
    low: "No mitigation required"

# Invariant-Specific Risk Policies
invariant_policies:
  authentication:
    - INV-001: "No enterprise SSO = CRITICAL risk (severity 95)"
    - INV-002: "No MFA = HIGH risk (severity 75)"
  
  authorization:
    - INV-003: "No RBAC = HIGH risk (severity 80)"
    - INV-004: "No service account = MEDIUM risk (severity 50)"
  
  multi_tenancy:
    - INV-005: "No tenant isolation = CRITICAL risk (severity 100)"
    - INV-006: "No tenant context = HIGH risk (severity 70)"
  
  audit_logging:
    - INV-007: "Mutable audit logs = CRITICAL risk (severity 90)"
    - INV-008: "PII in logs = CRITICAL risk (severity 95)"
  
  pii_protection:
    - INV-009: "PII unencrypted = CRITICAL risk (severity 100)"
    - INV-010: "No PII classification = HIGH risk (severity 75)"
    - INV-011: "No PII tagging = MEDIUM risk (severity 50)"
    - INV-012: "PII shared cross-tenant = CRITICAL risk (severity 100)"
    - INV-013: "PII retained >policy = HIGH risk (severity 80)"
    - INV-014: "No deletion API = MEDIUM risk (severity 60)"
  
  secrets_management:
    - INV-015: "Secrets in git = CRITICAL risk (severity 100)"
    - INV-016: "No secret rotation = HIGH risk (severity 70)"
    - INV-017: "Secrets >90 days = MEDIUM risk (severity 55)"
    - INV-018: "No vault storage = CRITICAL risk (severity 90)"
    - INV-019: "No secrets audit = HIGH risk (severity 65)"
  
  multi_cluster:
    - INV-036: "Single region only = HIGH risk (severity 75)"
    - INV-037: "SLO <99.9% = MEDIUM risk (severity 60)"
  
  cicd:
    - INV-020: "No pipeline enforcement = HIGH risk (severity 70)"
    - INV-021: "No rollback plan = CRITICAL risk (severity 85)"
    - INV-022: "Rollback not tested = HIGH risk (severity 75)"
    - INV-023: "Breaking changes without migration = MEDIUM risk (severity 65)"
  
  observability:
    - INV-033: "No structured logs = MEDIUM risk (severity 50)"
    - INV-034: "No health endpoint = HIGH risk (severity 70)"
    - INV-035: "No alerting = HIGH risk (severity 75)"
  
  incident_response:
    - INV-031: "No runbooks = HIGH risk (severity 70)"
    - INV-032: "Postmortem >5 days = MEDIUM risk (severity 45)"
  
  testing:
    - INV-024: "Coverage <80% = HIGH risk (severity 72)"
    - INV-025: "PR gate bypassed = MEDIUM risk (severity 55)"
  
  security:
    - INV-026: "No SAST = HIGH risk (severity 80)"
    - INV-027: "Vulnerable dependency = HIGH risk (severity 85)"
    - INV-028: "DAST failed = CRITICAL risk (severity 90)"
  
  data_retention:
    - INV-029: "No 7-year audit retention = HIGH risk (severity 75)"
    - INV-030: "User data >2 years = MEDIUM risk (severity 50)"
  
  dependencies:
    - INV-037: "Unapproved license = MEDIUM risk (severity 60)"
    - INV-038: "Copyleft license = MEDIUM risk (severity 55)"

# Compliance Integration
compliance:
  frameworks:
    - name: "SOC 2 Type II"
      requirements:
        - "All CRITICAL risks must be mitigated before audit"
        - "HIGH risks require quarterly review"
        - "Risk ledger must be immutable (git-backed)"
        - "Approval chains must be auditable"
    
    - name: "ISO 27001"
      requirements:
        - "Risk assessment required for all changes"
        - "Approval gates must match severity"
        - "Incident response must follow escalation paths"
        - "Annual risk review mandatory"
    
    - name: "GDPR"
      requirements:
        - "PII risks (INV-009 through INV-014) are CRITICAL by default"
        - "30-day breach notification (if risk materializes)"
        - "Data deletion must be <30 days (INV-014)"
        - "Cross-border transfer controls"
  
  reporting:
    frequency: "Quarterly"
    recipients: ["CISO", "Compliance Officer", "Audit Committee"]
    format: "Risk ledger export with statistics (total risks, severity distribution, approval SLA compliance)"

# Reflexion Triggers (from collapse_policy.md)
reflexion:
  risk_based_triggers:
    - "CRITICAL risk detected = immediate reflexion"
    - "HIGH risk without mitigation = reflexion within 1 hour"
    - "3+ MEDIUM risks in single Position Card = reflexion"
    - "Risk severity increases during implementation = reflexion"
    - "Mitigation plan rejected by approver = reflexion"
  
  reflexion_protocol:
    - step: 1
      action: "Agent reviews original Position Card"
      output: "Identifies which risk(s) triggered reflexion"
    - step: 2
      action: "Agent proposes revised approach"
      output: "New Position Card with lower risk profile"
    - step: 3
      action: "Skeptic evaluates new approach"
      output: "Risk assessment of revised plan"
    - step: 4
      action: "Verifier approves or requests further revision"
      output: "Approval decision + updated risk ledger"

# Legacy Rules (from v0, preserved for backward compatibility)
legacy_rules:
  - trigger: "AuthN/AuthZ or tenancy change"
    approvals: [security_signoff]
    note: "Now covered by INV-001 through INV-006 (CRITICAL/HIGH risks)"
  
  - trigger: "Production deploy"
    approvals: [prod_deploy]
    note: "Now covered by INV-020 through INV-022 (CI/CD pipeline rules)"
  
  - trigger: "Rollback disabled or manual"
    approvals: [prod_deploy, security_signoff]
    note: "Now INV-021 (CRITICAL risk, severity 85)"
